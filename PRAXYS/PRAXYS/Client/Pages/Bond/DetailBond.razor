@inherits DetailBondBase
@page  "/bonds/details/{BondID:int}"

<h4 class="mat-h4 mb-1">Informacion Fianza</h4>

@if (Bond != null)
{

<div class="row bounceInLeft animated">
    <div class="col-12">
        <div class="row">
            <div class="col-lg-8">
                <div class="card-box widget-inline mat-elevation-z4">
                    <div class="row d-flex justify-content-between">

                        <div class="col-sm-6 col-xl-2">
                            <div class="p-1 text-center">
                                <i class="mdi mdi-currency-usd text-blue mdi-24px"></i>
                                <h3><span data-plugin="counterup">Prima total</span></h3>
                                <p class="text-muted font-13 mb-0">@Bond.PremiumTotal</p>
                            </div>
                        </div>

                        <div class="col-sm-6 col-xl-2">
                            <div class="p-1 text-center">
                                <i class="mdi mdi-currency-usd text-danger mdi-24px"></i>
                                <h3><span data-plugin="counterup">Prima por pagar</span></h3>
                                <p class="text-muted font-13 mb-0">@Bond.PremiumTotal</p>
                            </div>
                        </div>


                        <div class="col-sm-6 col-xl-2">
                            <div class="p-1 text-center">
                                <i class="mdi mdi-currency-usd text-success mdi-24px"></i>
                                <h3><span data-plugin="counterup">Prima Pagada</span></h3>
                                <p class="text-muted font-13 mb-0">@Bond.PremiumTotal</p>
                            </div>
                        </div>

                    </div> <!-- end row -->
                </div> <!-- end card-box-->
            </div>
            <div class="col-lg-4">
                <div class="card-box widget-inline mat-elevation-z4">
                    <div class="row d-flex justify-content-between">

                        <div class="col-lg-12">
                            <div class="p-1 text-center">
                                <i class="mdi mdi-layers text-blue mdi-24px"></i>
                                <h3><span data-plugin="counterup">Vigencia</span></h3>
                                <p class="text-muted font-13 mb-0">De <span class="text-blue">@Bond.Start.Value.ToString("dd-MM-yyyy")</span> De <span class="text-blue">@Bond.End.Value.ToString("d-MM-yyyy")</span></p>
                            </div>
                        </div>

                    </div> <!-- end row -->
                </div> <!-- end card-box-->
            </div>
        </div><!--end row-->
    </div> <!-- end col-->
</div>


    @*---------------------------------- CONTENT -------------------------------------------*@

    <div class="mt-3">
        <div class="col-12 card-box mat-elevation-z4 px-3">
            <div class="row">
                <div class="col-lg-4">
                    <div class="card-box ribbon-box mat-elevation-z4">
                        <div class="ribbon ribbon-blue float-left"> Informacion General </div>
                        <div class="ribbon-content">
                            <table class="table">
                                <tr>
                                    <td>Cliente</td>
                                    <td>
                                        @if (Bond.Client.PersonType == "Fisica")
                                        {
                                            @($"{Bond.Client.Name} {Bond.Client.LastName} {Bond.Client.SecondLastName}")
                                        }
                                        else
                                        {
                                            @Bond.Client.CompanyName
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <td>Agente</td>
                                    <td>
                                        @if (Bond.Agent.PersonType == "Fisica")
                                        {
                                            @($"{Bond.Agent.Name} {Bond.Agent.LastName} {Bond.Agent.SecondLastName}")
                                        }
                                        else
                                        {
                                            @Bond.Agent.CompanyName
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <td>Compañia</td>
                                    <td>
                                        @Bond.Company.CompanyName
                                    </td>
                                </tr>
                                <tr>
                                    <td>Beneficiario</td>
                                    <td>
                                        @Bond.Beneficiary
                                    </td>
                                </tr>
                                <tr>
                                    <td>Grupo</td>
                                    <td>
                                        @if (Bond.SubAgent.PersonType == "Fisica")
                                        {
                                            @($"{Bond.SubAgent.Name} {Bond.SubAgent.LastName} {Bond.SubAgent.SecondLastName}")
                                        }
                                        else
                                        {
                                            @Bond.SubAgent.CompanyName
                                        }
                                    </td>
                                </tr>
                            </table>
                        </div><!--END RIBBON CONTENT-->
                    </div><!--END RIBBON BOX-->

                    <div class="card-box ribbon-box mat-elevation-z4 mt-2">
                        <div class="ribbon ribbon-success float-left"><i class="mdi mdi-access-point mr-1"></i> Detalles de Primas</div>
                        <div class="ribbon-content">
                            <table class="table">
                                <tr>
                                    <td>Monto de covertura</td>
                                    <td>@Bond.CovergeAmount</td>
                                </tr>
                                <tr>
                                    <td>Prima Neta</td>
                                    <td>@Bond.Premium</td>
                                </tr>
                                <tr>
                                    <td>Descuento</td>
                                    <td>@Bond.Fee</td>
                                </tr>
                                <tr>
                                    <td>Gastos de Expedicion</td>
                                    <td>@Bond.IssueCost</td>
                                </tr>
                                <tr>
                                    <td>Gastos de Buro</td>
                                    <td>@Bond.BureauCost</td>
                                </tr>
                                <tr>
                                    <td>IVA</td>
                                    <td>@Bond.Tax</td>
                                </tr>
                                <tr>
                                    <td>Prima Total</td>
                                    <td>@Bond.PremiumTotal</td>
                                </tr>
                            </table>
                        </div><!--END RIBBON CONTENT-->
                    </div><!--END RIBBON BOX-->
                </div><!--END COLUM-->

                <div class="col-lg-4">

                    <div class="card-box ribbon-box mat-elevation-z4">
                        <div class="ribbon ribbon-blue float-left"> Beneficiario </div>
                        <div class="ribbon-content">
                            <table class="table">
                                <tr>
                                    <td>Nombre Beneficiario</td>
                                    <td>@Bond.Beneficiary</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="card-box ribbon-box mat-elevation-z4">
                        <div class="ribbon ribbon-blue float-left"> Detalles </div>
                        <div class="ribbon-content">
                            <table class="table">
                                <tr>
                                    <td>Ramo</td>
                                    <td>@Bond.BranchID</td>
                                </tr>
                                <tr>
                                    <td>Riesgo</td>
                                    <td>@Bond.RiskTypeID</td>
                                </tr>
                                <tr>
                                    <td>Movimiento</td>
                                    <td>@Bond.MovementID</td>
                                </tr>
                                <tr>
                                    <td>Oficina</td>
                                    <td>@Bond.OfficeID</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card-box ribbon-box mat-elevation-z4">
                        <div class="ribbon ribbon-blue float-left"> Informacion Pago </div>
                        <div class="ribbon-content">
                            @if (Bond.BondPayments == null || Bond.BondPayments.Count == 0)
                            {
                                <div class="d-flex flex-column justify-content-center align-items-center bg-light" style="height:300px;">
                                    <i class="fas fa-comment-dollar fa-5x"></i>
                                    <h4>No se ha registrado ningun pago</h4>

                                    <button @onclick="OpenPayments" id='showModal' class="btn btn-blue width-xl ladda-button" data-style="zoom-in" data-animation="fadeIn">
                                        <i class="fas fa-comment-dollar"></i> Ver Pagos
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="d-flex justify-content-end mb-2">
                                    <div class="btn-group">
                                        <button class="btn btn-light" @onclick="OpenPayments"><i class="fas fa-money-check"></i>&nbsp; Agregar Pago</button>
                                    </div>
                                </div>

                                <table class="table table-responsive-lg table-striped table-hover border">
                                    <tr class="bg-blue text-white">
                                        <td>Fecha de Pago</td>
                                        <td>Liquidacion</td>
                                        <td class="text-center">Comission pagada</td>
                                        <td class="text-center">Prima Pagada</td>
                                        <td>
                                            Acciones
                                        </td>
                                    </tr>
                                    @foreach (var item in Bond.BondPayments)
                                    {
                                        <tr>
                                            <td>@item.PayedDate.Value.ToString("dd-MM-yyyy")</td>
                                            <td>@item.LiquidationNumber</td>
                                            <td class="text-center">
                                                @if (item.CommissionPayed)
                                                {
                                                    <i class="far fa-check-circle text-success text-center"></i>
                                                }
                                                else
                                                {
                                                    <i class="far fa-times-circle text-danger text-center"></i>
                                                }
                                            </td>
                                            <td class="text-center">
                                                @item.PremiumPayed
                                            </td>
                                            <td class="text-center">
                                                @if (!item.CommissionPayed)
                                                {
                                                    <div class="btn-group">
                                                        <button class="btn btn-light" @onclick="@(() => OpenComission(item.ID))"><i class="fas fa-money-check"></i>&nbsp; Comission</button>
                                                    </div>
                                                }
                                            </td>
                                        </tr>
                                        @if (item.CommissionPayed)
                                        {
                                            foreach (var comission in item.CommissionPayments)
                                            {
                                                <tr>
                                                    <td colspan="7" class="text-center font-weight-bold bg-soft-blue">
                                                        Comision
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td colspan="3">
                                                        <span class="font-weight-bold">Fecha de pago:</span>
                                                        <span>&nbsp;@comission.PayedDate</span>
                                                    </td>
                                                    <td colspan="2">
                                                        <span class="font-weight-bold">Monto de comision:</span>
                                                        <span>&nbsp;@comission.AmountPayed</span>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    }
                                </table>
                            }
                        </div><!--END RIBBON CONTENT-->
                    </div><!--END RIBOON CONTENT-->


                </div><!--END COL-->

            </div>
        </div><!--END COL-->
    </div><!--END ROW-->
}
else
{
    <div class="d-flex justify-content-center card-box mat-elevation-z4">
        <div class="spinner-grow avatar-lg text-secondary m-2 text-center" role="status"></div>
    </div>
}


@*----------------------------------BOND PAYMENT MODAL----------------------------------*@

<BSModal @ref="Modal" AnimationClass="fadeInLeft" Class="mat-elevation-z4">
    <BSModalHeader Class="bg-blue" OnClick="@(() => Modal.Hide())"><h3 class="text-white">Pagos</h3></BSModalHeader>
    <BSModalBody>
        @if (Bond != null)
        {
            @ModalContent
        }
    </BSModalBody>
</BSModal>

@code{

    RenderFragment ModalContent { get; set; }

    private void OpenPayments()
    {
            ModalContent =@<AddBondPayment BondID="Bond.ID" DataEvent="UploadData" />;
            Modal.Show();
    }

    private void OpenComission(int id)
    {
        ModalContent = @<AddComissionPayment BondPaymentID="id"/>;
        Modal.Show();
    }
    }